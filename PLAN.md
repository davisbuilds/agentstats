# AgentStats: Real-Time AI Agent Activity Dashboard

## Context

**Problem:** When running multiple AI agents (Claude Code, Codex) across projects, the only way to see what each agent is doing is to switch between terminal sessions and scroll through output. There's no unified view of current agent activity.

**Solution:** A localhost dashboard that shows what every running agent is doing *right now* — which tool it just called, what project/branch it's working on, and its recent activity stream — all in one browser tab. Think of it as a "mission control" for your AI agents.

This implementation covers Phase 1 (foundation) and Phase 2 (dashboard MVP) together.

**Key decisions:**
- Package manager: **pnpm**
- Ingestion: HTTP API (agents POST events to localhost)
- Backend: Node.js + TypeScript (Express, better-sqlite3)
- Frontend: Vanilla HTML/JS + Tailwind CSS (dark theme)
- Storage: SQLite (WAL mode) for persistence across restarts
- Real-time: Server-Sent Events (SSE)
- Auth: None — localhost trust (server binds 127.0.0.1 only)
- Payloads: Truncated to configurable cap (default 10KB per event)
- Dedup: Client-supplied `event_id` with UNIQUE constraint
- Schema versioning: `schema_version` field for forward compatibility

---

## Architecture

Single Node.js process serves everything:

```
Browser (localhost:3141)
    ├── GET /              → Dashboard (static HTML/JS/CSS)
    ├── GET /api/stream    → SSE (live events + stats)
    ├── GET /api/events    → Query events with filters
    ├── GET /api/stats     → Aggregated statistics
    ├── GET /api/sessions  → Active/recent sessions
    └── GET /api/health    → Server status

Agents (via hooks / adapters)
    ├── POST /api/events       → Ingest single event
    └── POST /api/events/batch → Ingest multiple events
```

---

## Project Structure

```
agentstats/
  package.json               ← pnpm managed
  pnpm-lock.yaml
  tsconfig.json
  tailwind.config.js
  .gitignore
  src/
    input.css                ← Tailwind entry (@tailwind directives)
    server.ts                ← Entry: Express, bind 127.0.0.1:3141
    config.ts                ← Env-based config with defaults
    db/
      connection.ts          ← better-sqlite3 init, WAL mode, pragmas
      schema.ts              ← CREATE TABLE / INDEX, run on startup
      queries.ts             ← Prepared statements for all operations
    api/
      router.ts              ← Mount all route handlers
      events.ts              ← POST + GET /api/events
      stats.ts               ← GET /api/stats
      sessions.ts            ← GET /api/sessions
      stream.ts              ← GET /api/stream (SSE)
      health.ts              ← GET /api/health
    sse/
      emitter.ts             ← EventEmitter-based SSE fan-out
  public/
    index.html               ← Dashboard (single page)
    css/
      output.css             ← Generated by Tailwind CLI
    js/
      app.js                 ← Init: fetch data, connect SSE, render
      sse-client.js          ← EventSource with auto-reconnect
      components/
        agent-cards.js       ← Per-agent live activity cards (PRIMARY)
        event-feed.js        ← Global live event feed
        stats-bar.js         ← Top-level stat counters
        session-list.js      ← Session sidebar
  scripts/
    seed.ts                  ← Generate fake multi-agent events
  data/                      ← SQLite DB (gitignored)
```

---

## SQLite Schema

Three tables: `agents`, `sessions`, `events`. Denormalized fields on `events` for fast queries.

```sql
CREATE TABLE agents (
  id TEXT PRIMARY KEY,
  agent_type TEXT NOT NULL,                -- "claude_code" | "codex"
  name TEXT,
  registered_at TEXT NOT NULL DEFAULT (datetime('now')),
  last_seen_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  agent_id TEXT NOT NULL,
  agent_type TEXT NOT NULL,
  project TEXT,
  branch TEXT,
  status TEXT NOT NULL DEFAULT 'active',   -- "active" | "idle" | "ended"
  started_at TEXT NOT NULL DEFAULT (datetime('now')),
  ended_at TEXT,
  last_event_at TEXT NOT NULL DEFAULT (datetime('now')),
  metadata TEXT DEFAULT '{}'
);

CREATE TABLE events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  event_id TEXT UNIQUE,                    -- client UUID for idempotent dedup
  schema_version INTEGER NOT NULL DEFAULT 1,
  session_id TEXT NOT NULL,
  agent_type TEXT NOT NULL,
  event_type TEXT NOT NULL,                -- "tool_use" | "session_start" | "session_end" | "response" | "error"
  tool_name TEXT,
  status TEXT DEFAULT 'success',           -- "success" | "error" | "timeout"
  tokens_in INTEGER DEFAULT 0,
  tokens_out INTEGER DEFAULT 0,
  branch TEXT,
  project TEXT,
  duration_ms INTEGER,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  metadata TEXT DEFAULT '{}'               -- truncated to configurable max
);

CREATE INDEX idx_events_created_at ON events(created_at);
CREATE INDEX idx_events_session_id ON events(session_id);
CREATE INDEX idx_events_event_type ON events(event_type);
CREATE INDEX idx_events_tool_name ON events(tool_name);
CREATE INDEX idx_events_agent_type ON events(agent_type);
CREATE INDEX idx_sessions_status ON sessions(status);
```

Pragmas: `journal_mode = WAL`, `synchronous = NORMAL`, `foreign_keys = ON`.

---

## HTTP API

### `POST /api/events` — Ingest single event
```json
{
  "event_id": "550e8400-e29b-41d4-a716-446655440000",
  "session_id": "abc-123",
  "agent_type": "claude_code",
  "event_type": "tool_use",
  "tool_name": "Bash",
  "status": "success",
  "tokens_in": 150,
  "tokens_out": 420,
  "branch": "feature/auth",
  "project": "myapp",
  "duration_ms": 1200,
  "metadata": { "command": "npm test" }
}
```
- `event_id` optional; duplicates silently ignored (UNIQUE constraint)
- `metadata` truncated server-side to configurable max
- Auto-creates agent/session on first event (upsert)
- Broadcasts to SSE clients after insert

### `POST /api/events/batch` — Ingest multiple events
```json
{ "events": [ ...array of event objects... ] }
```

### `GET /api/events` — Query with filters
Params: `limit`, `offset`, `agent_type`, `event_type`, `tool_name`, `session_id`, `branch`, `since`, `until`

### `GET /api/stats` — Aggregated statistics
Returns: total_events, active_sessions, total_tokens, tool_breakdown, agent_breakdown, branches

### `GET /api/sessions` — Session list
Params: `status`, `agent_type`, `limit`

### `GET /api/stream` — SSE endpoint
Message types: `event` (each new event), `stats` (aggregated, every 5s), `session_update` (status changes). 30s heartbeat.

### `GET /api/health` — Server status
Returns: status, uptime, db_size_bytes

---

## Dashboard UI — "What Is Each Agent Doing Right Now?"

The dashboard is designed around the core use case: **replacing terminal-hopping with a single view of all agent activity.** The primary visual element is per-agent activity cards, not an abstract stats dashboard.

### Layout
```
┌──────────────────────────────────────────────────────────────────────┐
│  AgentStats         Events: 1,547  Sessions: 3  Tokens: 245K/890K  │
│                                                      ● Connected    │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─ Claude Code ─────────────────┐  ┌─ Claude Code ───────────────┐ │
│  │  myapp / feature/auth         │  │  api-server / main          │ │
│  │  ● Active · 47 events · 12m   │  │  ○ Idle · 23 events · 34m  │ │
│  │                               │  │                             │ │
│  │  NOW: Running Bash            │  │  LAST: Wrote server.ts      │ │
│  │  ▸ npm test                   │  │  ▸ 3m ago                   │ │
│  │                               │  │                             │ │
│  │  Recent:                      │  │  Recent:                    │ │
│  │  14:22 Bash   npm test     ✓  │  │  13:48 Write  server.ts  ✓ │ │
│  │  14:21 Edit   auth.ts     ✓  │  │  13:47 Read   config.ts  ✓ │ │
│  │  14:20 Read   auth.ts     ✓  │  │  13:45 Bash   npm build  ✓ │ │
│  │  14:19 Grep   "login"    ✓  │  │  13:44 Grep   "port"     ✓ │ │
│  │  14:18 Glob   **/*.ts    ✓  │  │  13:43 Edit   index.ts   ✓ │ │
│  └───────────────────────────────┘  └─────────────────────────────┘ │
│                                                                      │
│  ┌─ Codex ───────────────────────┐                                  │
│  │  frontend / redesign-nav      │                                  │
│  │  ● Active · 8 events · 5m     │                                  │
│  │                               │                                  │
│  │  NOW: Processing turn...      │                                  │
│  │                               │                                  │
│  │  Recent:                      │                                  │
│  │  14:23 response  turn done ✓  │                                  │
│  │  14:20 response  turn done ✓  │                                  │
│  └───────────────────────────────┘                                  │
│                                                                      │
├──────────────────────────────────────────────────────────────────────┤
│  All Events (live feed)                                              │
│  14:23 Codex   frontend   response   turn done              ✓      │
│  14:22 Claude  myapp      Bash       npm test                ✓      │
│  14:21 Claude  myapp      Edit       auth.ts                 ✓      │
│  14:20 Codex   frontend   response   turn done              ✓      │
│  14:20 Claude  myapp      Read       auth.ts                 ✓      │
│  14:19 Claude  myapp      Grep       "login"                ✓      │
│  ...                                                                 │
└──────────────────────────────────────────────────────────────────────┘
```

### Design Principles

1. **Agent cards are the hero element.** Each active/recent session gets its own card showing: agent type, project, branch, status, current activity ("NOW:" line), and a mini event feed. This directly replaces switching between terminals.

2. **"NOW" indicator is the most important line.** For active sessions, it shows what the agent is currently doing (e.g., "Running Bash: npm test", "Editing auth.ts", "Reading config.ts"). Updated instantly via SSE. For idle sessions, it shows the last action with relative time.

3. **Stats bar is compact, not primary.** Total events, sessions, tokens are shown in a single header row — useful but not the focus. The focus is the agent cards.

4. **Global event feed is secondary.** Below the agent cards, a unified chronological feed shows all events across all agents. Color-coded by agent type. Useful for seeing the full interleaved timeline.

5. **Cards auto-appear and auto-sort.** New sessions create new cards automatically. Active sessions sort before idle. Ended sessions fade out after a timeout.

### Visual Design (Dark Theme)
- Background: `gray-950` page, `gray-900` cards
- Card borders: `gray-700`, with `green-500` left border for active, `yellow-500` for idle, `gray-600` for ended
- "NOW" line: `white` text, `green-400` indicator dot when active
- Event type badges: `green` = tool_use success, `red` = error, `blue` = response, `yellow` = session lifecycle
- Status dots: green = active, yellow = idle, gray = ended
- Agent type labels: `purple` for Claude Code, `emerald` for Codex

### Frontend Components

- **agent-cards.js** (PRIMARY): Renders one card per active/recent session. Each card has: header (agent type, project, branch, status), "NOW" current activity line, mini event feed (last 5-10 events). Cards are created/removed dynamically as sessions start/end. Active cards sort to the top.

- **stats-bar.js**: Single header row with compact counters (total events, active sessions, connected agents, token usage). Updated from SSE `stats` messages.

- **event-feed.js**: Global chronological event list below the agent cards. Shows last 100 events across all agents. New events prepend with animation. Auto-scroll when at bottom, "N new events" badge when scrolled up.

- **sse-client.js**: EventSource wrapper with exponential backoff reconnect. Connection status indicator (green/yellow/red dot in header). Dispatches events to all components.

---

## Implementation Steps

### Step 1: Project scaffolding
- `pnpm init`
- `pnpm add express better-sqlite3 uuid`
- `pnpm add -D typescript @types/node @types/express @types/better-sqlite3 tsx tailwindcss`
- Create `tsconfig.json` (target ES2022, module NodeNext, outDir dist)
- Create `tailwind.config.js` (content: `./public/**/*.{html,js}`)
- Create `.gitignore` (node_modules, dist, data/, public/css/output.css)
- Create directory structure

### Step 2: Config + Database layer
- `src/config.ts`: All env-based config with defaults
- `src/db/connection.ts`: Init better-sqlite3, WAL mode, pragmas
- `src/db/schema.ts`: CREATE TABLE/INDEX statements, run on startup
- `src/db/queries.ts`: Prepared statements for insert, upsert, query, aggregate

### Step 3: SSE broadcaster
- `src/sse/emitter.ts`: Client set, broadcast(), 30s heartbeat, cleanup on disconnect

### Step 4: API routes
- `src/api/events.ts`: POST single + batch (validate, truncate metadata, insert, upsert agent/session, broadcast SSE) + GET with filters
- `src/api/stats.ts`: Aggregation queries
- `src/api/sessions.ts`: List with status/agent filter
- `src/api/stream.ts`: SSE endpoint with periodic stats broadcast (5s)
- `src/api/health.ts`: Uptime, DB size
- `src/api/router.ts`: Mount all under /api

### Step 5: Server entry
- `src/server.ts`: Express app, bind 127.0.0.1, serve `public/`, mount API router, init DB, start session timeout checker (60s interval)

### Step 6: Dashboard HTML
- `public/index.html`: Dark theme layout — stats bar, agent cards grid, global event feed. Script tags for all JS.

### Step 7: Dashboard JavaScript
- `public/js/app.js`: Fetch initial data (GET /api/sessions, /api/events, /api/stats), render all components, connect SSE
- `public/js/sse-client.js`: EventSource + reconnect + status indicator
- `public/js/components/agent-cards.js`: Per-session cards with "NOW" indicator + mini feed
- `public/js/components/stats-bar.js`: Compact header counters
- `public/js/components/event-feed.js`: Global event list with auto-scroll

### Step 8: Tailwind CSS build
- `src/input.css` with @tailwind directives
- `pnpm run css:build` → `npx tailwindcss -i src/input.css -o public/css/output.css --minify`

### Step 9: Seed script
- `scripts/seed.ts`: Generate realistic multi-agent, multi-session events with staggered timing. POST to the API. Simulates 2-3 concurrent agents working on different projects.

### Step 10: Dev scripts + verification
- `pnpm run dev`: `tsx watch src/server.ts` (add tailwind watch with concurrently if needed)
- `pnpm run build`: `tsc && npx tailwindcss -i src/input.css -o public/css/output.css --minify`
- `pnpm start`: `node dist/server.js`

---

## Dependencies

**Runtime (3):** `express`, `better-sqlite3`, `uuid`
**Dev (6):** `typescript`, `@types/node`, `@types/express`, `@types/better-sqlite3`, `tsx`, `tailwindcss`

---

## Configuration

| Variable | Default | Description |
|---|---|---|
| `AGENTSTATS_PORT` | `3141` | Server port |
| `AGENTSTATS_HOST` | `127.0.0.1` | Bind address |
| `AGENTSTATS_DB_PATH` | `./data/agentstats.db` | SQLite database path |
| `AGENTSTATS_MAX_PAYLOAD_KB` | `10` | Max metadata size per event (truncated) |
| `AGENTSTATS_SESSION_TIMEOUT` | `30` | Minutes before idle mark |
| `AGENTSTATS_MAX_FEED` | `200` | Max events in global feed |
| `AGENTSTATS_STATS_INTERVAL` | `5000` | Stats broadcast interval (ms) |

---

## Verification

1. `pnpm run build` compiles without errors
2. `pnpm start` → prints "AgentStats listening on http://127.0.0.1:3141"
3. `curl -X POST localhost:3141/api/events -H 'Content-Type: application/json' -d '{"session_id":"s1","agent_type":"claude_code","event_type":"tool_use","tool_name":"Bash","project":"myapp","branch":"main"}'` → 201
4. `curl localhost:3141/api/stats` → returns JSON with counts
5. Open http://localhost:3141 → dark dashboard with agent cards, stats bar, event feed
6. Run seed script → multiple agent cards appear, events stream in real time, "NOW" indicators update live
7. Multiple browser tabs receive independent SSE streams

---

## Future Phases (not built now)

- **Phase 3**: Claude Code hook scripts + Codex notify adapter (shell scripts that POST to the API)
- **Phase 4**: Charts, filtering/search, session detail drill-down, token cost estimation, data export, optional API key auth, DB retention policy
